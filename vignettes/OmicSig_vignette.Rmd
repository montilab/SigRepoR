---
title: "OmicSig-vignette"
output: rmarkdown::html_vignette
author: "Vanessa Mengze Li"
date: "Sept 24th 2020"
vignette: >
  %\VignetteIndexEntry{OmicSig-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

If you haven't installed `SigRepoR` yet, please contact vmli@bu.edu for instruction.
```{r message=FALSE, warning=FALSE}
# devtools::document()
library(SigRepoR)
library(dplyr)
```

## Create an OmicSignature Object 
An `OmicSignature` object contains three parts:  
 - **metadata**, a list contains metadata fields;  
 - **signature**, a dataframe with feature symbols and directions, and scores if applicable;  
 - **difexp**, optional, a dataframe from differential expression analysis result.  

The example provided below is from an experiment for Myc gene reduce in mice. 
Signatures was extracted by comparing the liver of treatment and control when 
mice is 24-month old. This is a bi-directional signature example, which contains 
up and down regulated features (genes).

### Specify metadata
To be saved into a OmicSignature object, the required **metadata** fields are:  
**"signature_name", "organism", "platform", "direction_type", "phenotype"**.  
We can also specify other criterias such as fdr and log fold change cutoff of 
the signature, and provide key words of our experiment to make the description 
more complete.
One option is to create metadata list by hand, similar as follows:
```
metadata <- list(
  "signature_name" = Myc_reduce_mice_liver_24m,
  "organism" = "Mus Musculus",
  "sample_type" = "liver",
  "phenotype" = "Myc_reduce",
  "direction_type" = "bi-directional",
  "platform" = "GPL6246",
  "fdr_cutoff" = 0.05,
  "score_cutoff" = 7,
  "keywords" = c("Myc", "KO", "longevity"),
  "PMID" = 25619689,
  "year" = 2015
)
```
Or use our build-in function `createMetadata` (recommended):
```{r}
metadata <- createMetadata(
  signature_name = "Myc_reduce_mice_liver_24m",
  organism = "Mus Musculus",
  sample_type = "liver",
  phenotype = "Myc_reduce",
  direction_type = "bi-directional",
  platform = "GPL6246",
  fdr_cutoff = 0.05,
  score_cutoff = 7,
  keywords = c("Myc", "KO", "longevity"),
  PMID = 25619689,
  year = 2015
)
```

If "sample_type" is not a BRENDA ontology name or "platform" is not a valid GEO platform accession ID, you will receive warnings when creating the OmicSignature object. See more info about these two fields below.

#### Additional info for "sample_type" and "platform"
In this example, the sample_type is a mouse strain and not a BRENDA tissue ontology term. But if your signature was generated from a specific cell or tissue, we highly recommended you to **specify the cell or tissue name using the standard BRENDA ontology term**. e.g. "SUM-149PT cell", and not "SUM 149 PT".  
You can find the correct ontology term to use by `BRENDASearch()` function.  
For example, search for ontology terms contain "SUM" and "cell":
```{r}
BRENDASearch("SUM cell")
```

In addition, we use GEO platform accession ID, e.g. "GPL6246", in our *SigRepo database*. If you are not sure about your GEO platform accession ID, you can search by using function `GEOPlatformSearch()`.  
For example, search for platform names contains "illumina" and species name contains "homo":
```{r}
GEOPlatformSearch("illumina", species = "homo")
```


### Read in a matrix of differential expression analysis result
The differential expression analysis in this example was performed using a standard 
pipeline from lm package. Available columns are logFC, AveExpr, t score, P.Value, 
adj.P.Val, B score, Probe.ID, gene_symbol and gene_name.
```{r}
difexp <- read.table(file.path(system.file("extdata", package = "SigRepoR"), "difmatrix_Myc_mice_liver_24m_raw.txt"),
  header = TRUE, sep = "\t", stringsAsFactors = FALSE
)
head(difexp)
```
To be saved into a OmicSignature object, the required columns for
**differential expression matrix** are:  
**"probe_id", "symbol", "score", "p_value", "fdr"**.  

Modify the column names to match the requirement.  
Our build-in function `replaceDifexpCol()` is designed to replace some 
frequently-used alternative column names. You can also change the column names manully.
```{r}
colnames(difexp) <- replaceDifexpCol(colnames(difexp))
head(difexp)
```


### Create signature
This is a bi-directional signature example. It contains up and down regulated 
genes.  
There are multiple ways to get signatures from a differential expression 
analysis matrix. One way is to use `filter()` from `dplyr` package.

```{r}
temp_upsig <- cbind(
  filter(difexp, score > metadata$score_cutoff & fdr < metadata$fdr_cutoff) %>% pull(symbol),
  filter(difexp, score > metadata$score_cutoff & fdr < metadata$fdr_cutoff) %>% pull(score),
  "+"
)
head(temp_upsig)

temp_dnsig <- cbind(
  dplyr::filter(difexp, score < (-1) * metadata$score_cutoff & fdr < metadata$fdr_cutoff) %>% pull(symbol),
  dplyr::filter(difexp, score < (-1) * metadata$score_cutoff & fdr < metadata$fdr_cutoff) %>% pull(score),
  "-"
)
head(temp_dnsig)
```
(note: if you see numbers instead of gene symbol name in the first column, please check if the "symbol" column in your difexp matrix is "character" and not accidentally be "factor")  


The **signature** need to be a **dataframe** with column **"signature_symbol"**.  
If the signature is "bi-directional" or "multi-directional" (specified in 
`direction_type` in `metadata` list), then column **"signature_direction"** is 
also required. "uni-directional" type does not require this column.  
An **optional column "signature_score"** is used when feature scores are available.  

```{r}
signatures <- data.frame(rbind(temp_upsig, temp_dnsig))
colnames(signatures) <- c("signature_symbol", "signature_score", "signature_direction")
```

Our function `standardezeSigDF()` can help you to remove duplicate rows, empty symbols in the signature dataframe, if any.
```{r}
signatures <- standardezeSigDF(signatures)
head(signatures)
tail(signatures)
```


### Create OmicSignature object
We have everything we need now.  
Use `OmicSignature$new()` to create a new OmicSignature R6 object.  
```{r}
OmicObj <- OmicSignature$new(
  metadata = metadata,
  signature = signatures,
  difexp = difexp
)
```

Use `print()` to see its information:
```{r}
print(OmicObj)
```

You can also ask the program to print the messages while creating the 
OmicSignature Object. By default, `print_message` is set to be `FALSE`.
```{r}
OmicObj <- OmicSignature$new(
  metadata = metadata,
  signature = signatures,
  difexp = difexp,
  print_message = TRUE
)
```

### Extract new signatures from the `OmicSignature` object
Previously we created the signature using abs(logfc) > 1 and fdr < 0.005.
Now we can use new criterias to extract new signatures conveniently from 
the OmicSignature Object.  
For example, extract all features with a t-score with absolute value 
higher than 20 and fdr less than 0.001:
```{r}
OmicObj$extract.signature("abs(score) > 20; fdr < 0.001")
```

## Write OmicSignature Object into a .json file
Besides save the OmicSignature object as an `.rds` file, we can also save it as 
a `.json` text file:
```
writeJson(OmicObj, "Myc_reduce_mice_liver_24m.json")
```

We can also read in a OmicSignature object from a `.json` file.  
The following two examples are from the same Myc reduce study in mice, with muscle and adipose tissue.  
```{r}
OmicObj1 <- readJson(file.path(system.file("extdata", package = "SigRepoR"), "Myc_reduce_mice_muscle_24m_obj.json"))
OmicObj2 <- readJson(file.path(system.file("extdata", package = "SigRepoR"), "Myc_reduce_mice_adipose_24m_obj.json"))
```

## Create an OmicSignatureCollection Object
An `OmicSignatureCollection` object contains two parts:  
 - metadata  
 - OmicSigList, a list of OmicSignature Objects  

### Specify metadata for the collection
The required fields for **metadata** are:  
**"collection_name", "description"**. We can also add additional 
fields.  
```{r}
ColMeta <- list(
  "collection_name" = "Myc_mice_collection",
  "description" = "A collection for Myc reduced mice 24 month",
  "organism" = "Mus Musculus",
  "author" = "me"
)
```

Create an `OmicSignatureCollection` object.  
Use `OmicSignatureCollection$new()` and provide our metadata and a list of 
`OmicSignature` objects: 
```{r}
OmicCol <- OmicSignatureCollection$new(
  OmicSigList = list(OmicObj, OmicObj1, OmicObj2),
  metadata = ColMeta,
  print_message = FALSE
)
```
By default, `print_message` is set to `FALSE`. You can change it to `TRUE` to 
see the messages. During the creation of OmicSignatureCollection object, all 
input `OmicSignature` objects will be re-created to make sure they are all valid.  

### See a summary of the metadata of the OmicSignature objects in the Collection
`$metadataSummary()` will print out the metadata fields in all _OmicSignature_ 
objects stored in the _OmicSignatureCollection_.  
When parameter "only_shared" is set to be `TRUE`, only shared metadata fields 
among all _OmicSignature_ objects will be included. Otherwise, all metadata 
fields will be included.
```{r}
OmicCol$metadataSummary(only_shared = TRUE)
```

### Extract new signatures from the `OmicSignatureCollection` object
We can extract new signatures from the `OmicSignatureCollection` object using 
new criterias.  
By default, the features are ranked by score.  
By default, `bind` is set to be `TRUE` to output results from all *OmicSignature* 
objects as a single dataframe.  
For example, extract all features with a absolute score > 20 and fdr < 0.001.  
```
OmicCol$extract.signature("abs(score) > 20 & fdr < 0.001", bind = TRUE)
```
```
  sig_name        symbol             score direction
15 Myc_reduce_mice_adipose_24m        Crisp1           85.2374         +
16 Myc_reduce_mice_adipose_24m        Akr1b7           49.0361         +
17 Myc_reduce_mice_adipose_24m          Pcp4           40.2846         +
19 Myc_reduce_mice_adipose_24m        Spink8           36.2846         +
2    Myc_reduce_mice_liver_24m          Cpa1  34.6200756063927         +
20 Myc_reduce_mice_adipose_24m           Kap           30.6262         +
21 Myc_reduce_mice_adipose_24m         Ces5a           30.0132         +
5    Myc_reduce_mice_liver_24m          Zg16  28.5156178872557         +
23 Myc_reduce_mice_adipose_24m        Defb26           27.7851         +
24 Myc_reduce_mice_adipose_24m          Smcp           27.3482         +
25 Myc_reduce_mice_adipose_24m       Sprr2a2           27.2045         +
26 Myc_reduce_mice_adipose_24m     Serpina1f           25.5037         +
7    Myc_reduce_mice_liver_24m 2210010C04Rik  24.5444574823074         +
9    Myc_reduce_mice_liver_24m         Cidec  23.3957330874696         +
28 Myc_reduce_mice_adipose_24m         Ptgs2           23.0415         +
29 Myc_reduce_mice_adipose_24m          Gm46           22.9144         +
10   Myc_reduce_mice_liver_24m        Amy2a5  22.9129404550606         +
30 Myc_reduce_mice_adipose_24m           Npy           22.5157         +
31 Myc_reduce_mice_adipose_24m        Tmem27           22.4873         +
12   Myc_reduce_mice_liver_24m           Pf4  21.7125952561703         +
14   Myc_reduce_mice_liver_24m          Cpb1  20.9805702547365         +
36 Myc_reduce_mice_adipose_24m        Defb39           20.3322         +
37 Myc_reduce_mice_adipose_24m          Miox           20.2977         +
38 Myc_reduce_mice_adipose_24m      Ceacam10           20.2184         +
18 Myc_reduce_mice_adipose_24m          Mmp7          -36.8727         -
1    Myc_reduce_mice_liver_24m          Saa1 -35.2999683556117         -
3    Myc_reduce_mice_liver_24m       Sult3a1 -31.7552657607558         -
4    Myc_reduce_mice_liver_24m        Isyna1  -29.932550857117         -
22 Myc_reduce_mice_adipose_24m       Ighv3-5          -29.0765         -
6    Myc_reduce_mice_liver_24m         Chil1 -25.4131776388419         -
27 Myc_reduce_mice_adipose_24m       Fam183b          -24.8649         -
8    Myc_reduce_mice_liver_24m          Saa2 -23.8145207179964         -
11   Myc_reduce_mice_liver_24m       Sult1e1 -22.7634504761229         -
32 Myc_reduce_mice_adipose_24m          Sntn          -22.0401         -
33 Myc_reduce_mice_adipose_24m      Atp6v0d2          -21.7473         -
13   Myc_reduce_mice_liver_24m          Orm3 -21.2508766114784         -
34 Myc_reduce_mice_adipose_24m          Spp1          -20.9817         -
35 Myc_reduce_mice_adipose_24m         Plet1          -20.3752         -
```

If `bind` is set to be `FALSE`, the output of each *OmicSignature* objects are 
provided individually as one element in a list.
```
OmicCol$extract.signature("abs(score) > 20 & fdr < 0.001", bind = FALSE)
```
```
$Myc_reduce_mice_liver_24m
          symbol             score direction
1           Saa1 -35.2999683556117         -
2           Cpa1  34.6200756063927         +
3        Sult3a1 -31.7552657607558         -
4         Isyna1  -29.932550857117         -
5           Zg16  28.5156178872557         +
6          Chil1 -25.4131776388419         -
7  2210010C04Rik  24.5444574823074         +
8           Saa2 -23.8145207179964         -
9          Cidec  23.3957330874696         +
10        Amy2a5  22.9129404550606         +
11       Sult1e1 -22.7634504761229         -
12           Pf4  21.7125952561703         +
13          Orm3 -21.2508766114784         -
14          Cpb1  20.9805702547365         +

$Myc_reduce_mice_muscle_24m
NULL

$Myc_reduce_mice_adipose_24m
      symbol    score direction
1     Crisp1  85.2374         +
2     Akr1b7  49.0361         +
3       Pcp4  40.2846         +
4       Mmp7 -36.8727         -
5     Spink8  36.2846         +
6        Kap  30.6262         +
7      Ces5a  30.0132         +
8    Ighv3-5 -29.0765         -
9     Defb26  27.7851         +
10      Smcp  27.3482         +
11   Sprr2a2  27.2045         +
12 Serpina1f  25.5037         +
13   Fam183b -24.8649         -
14     Ptgs2  23.0415         +
15      Gm46  22.9144         +
16       Npy  22.5157         +
17    Tmem27  22.4873         +
18      Sntn -22.0401         -
19  Atp6v0d2 -21.7473         -
20      Spp1 -20.9817         -
21     Plet1 -20.3752         -
22    Defb39  20.3322         +
23      Miox  20.2977         +
24  Ceacam10  20.2184         +
```


Thank you! Please contact vmli@bu.edu if you have any questions.

--
