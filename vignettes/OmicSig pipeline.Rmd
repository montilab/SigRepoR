---
title: "Create OmicSig template"
author: "Vanessa"
date: "Aug 3rd 2020"
output:
  rmarkdown::html_document:
    theme: lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## library and functions
```{r message=FALSE, warning=FALSE}
library(SigRepoR)
library(dplyr)
```
or read the scripts if you don't have library:
```
path <- "SigRepo/OmicSig_Shiny/OmicSignature/"
source(paste(path, "OmicSignature.R", sep = ""))
source(paste(path, "Function_json.R", sep = ""))
source(paste(path, "Function_createMetadata.R", sep = ""))
source(paste(path, "Function_replaceDifexpCol.R", sep = ""))
source(paste(path, "Function_replaceSigCol.R", sep = ""))
source(paste(path, "Function_standardizeSigDF.R", sep = ""))
```

## define sample name and metadata **manually**
```{r}
sample_name <- "Ketodiet_mice_kidney_KetoDiet_vs_HighFat"
metadata <- createMetadata(
  signature_name = sample_name, # required
  organism = "Mus Musculus", # required
  sample_type = "C57BL/6",  
  phenotype = "Ketogenic diet",  # required
  direction_type = "bi-directional",  # required
  platform = "GPL13112",  # required
  p_value_cutoff = 0.02,
  logFC_cutoff = 0.379,
  keywords = c("Ketogenic diet", "longevity"),
  cutoff_description = "log2fc is used as score; cutoff was the same as the original study",
  PMID = 28877458,
  year = 2017,
  description = NULL
)
```

## read diffexp matrix
```{r}
file <- "/Users/hanameel/Crassula/Signature Collect/Ketogenic diet in mice/difmatrix_kidney_KDHF.txt"
difexp <- read.table(file,
  header = TRUE, stringsAsFactors = FALSE, sep = "\t",
  quote = "", fill = FALSE
)
dim(difexp)
head(difexp)
```

Modify column names to standard ones.  
Required columns for Differential Matrix: **symbol, score, p_value, fdr**.
```{r}
colnames(difexp) <- replaceDifexpCol(colnames(difexp))
head(difexp)
```

## generate signature - for bidirectional
up:
```{r}
temp_upsig <- cbind(
  filter(difexp, score > metadata$logFC_cutoff & p_value < metadata$p_value_cutoff) %>% pull(symbol),
  filter(difexp, score > metadata$logFC_cutoff & p_value < metadata$p_value_cutoff) %>% pull(score),
  "+"
)
nrow(temp_upsig) # number of up sig
head(temp_upsig)
```

dn:
```{r}
temp_dnsig <- cbind(
  filter(difexp, score < (-1) * metadata$logFC_cutoff & p_value < metadata$p_value_cutoff) %>% pull(symbol),
  filter(difexp, score < (-1) * metadata$logFC_cutoff & p_value < metadata$p_value_cutoff) %>% pull(score),
  "-"
)
nrow(temp_dnsig) # number of dn sig
head(temp_dnsig)
```

create signature dataframe:
```{r}
signatures <- data.frame(rbind(temp_upsig, temp_dnsig))
colnames(signatures) <- c("signature_symbol", "signature_score", "signature_direction")
```

filter out empty rows, empty symbols, duplicate symbols:
```{r}
signatures <- standardezeSigDF(signatures)
nrow(signatures)
table(signatures$signature_direction)
rbind(head(signatures), tail(signatures))
```

If you are not satisfied with the signature result, 
go back and modify cutoffs in metadata.

## create OmicSig obj:
```{r}
Omic.obj <- OmicSignature$new(metadata, signatures, difexp, print_message = F)
print(Omic.obj)
```

## write OmicSig obj:
```{r}
writeJson(Omic.obj, file = paste(sample_name, "_obj.json", sep = ""))
saveRDS(Omic.obj, file = paste(sample_name, "_obj.rds", sep = ""))
```

thx!
